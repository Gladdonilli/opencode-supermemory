# GitHub Workflow: PR Bot Review Aggregator
# 
# Purpose: Aggregates Macroscope/Greptile reviews into a summary and labels PR
# when bots finish reviewing. Helps you know when to run /pr-update.
#
# Usage: Copy to .github/workflows/pr-bot-aggregator.yml in your repo
#
# Triggers:
# - When Greptile or Macroscope posts a review/comment
# - Creates summary comment with all bot feedback
# - Adds "bot-reviewed" label when both bots have responded

name: PR Bot Review Aggregator

on:
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]

jobs:
  aggregate-reviews:
    name: Aggregate Bot Reviews
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request != null && 
      (contains(github.event.comment.user.login, 'greptile') || 
       contains(github.event.comment.user.login, 'macroscope') ||
       contains(github.event.review.user.login, 'greptile') ||
       contains(github.event.review.user.login, 'macroscope'))
    
    steps:
      - name: Get PR Number
        id: pr
        run: |
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Collect Bot Comments
        id: collect
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });
            
            const botComments = comments.filter(c => 
              c.user.login.includes('greptile') || 
              c.user.login.includes('macroscope')
            );
            
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const botReviews = reviews.filter(r =>
              r.user.login.includes('greptile') ||
              r.user.login.includes('macroscope')
            );
            
            const greptileResponded = botComments.some(c => c.user.login.includes('greptile')) ||
                                      botReviews.some(r => r.user.login.includes('greptile'));
            const macroscopeResponded = botComments.some(c => c.user.login.includes('macroscope')) ||
                                        botReviews.some(r => r.user.login.includes('macroscope'));
            
            let issueCount = 0;
            const allBotContent = [...botComments.map(c => c.body), ...botReviews.map(r => r.body)].join('\n');
            const bulletMatches = allBotContent.match(/^[\s]*[-*]/gm) || [];
            const numberMatches = allBotContent.match(/^[\s]*\d+\.\s/gm) || [];
            issueCount = bulletMatches.length + numberMatches.length;
            
            core.setOutput('greptile', greptileResponded);
            core.setOutput('macroscope', macroscopeResponded);
            core.setOutput('both', greptileResponded && macroscopeResponded);
            core.setOutput('issueCount', issueCount);

      - name: Add Label When Both Bots Done
        if: steps.collect.outputs.both == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              labels: ['bot-reviewed']
            });

      - name: Post Summary Comment
        if: steps.collect.outputs.both == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const issueCount = ${{ steps.collect.outputs.issueCount }};
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingSummary = comments.find(c => 
              c.user.login === 'github-actions[bot]' && 
              c.body.includes('Bot Review Summary')
            );
            
            if (existingSummary) {
              console.log('Summary already posted');
              return;
            }
            
            const summary = [
              '## Bot Review Summary',
              '',
              'Both **Greptile** and **Macroscope** have reviewed this PR.',
              '',
              '| Bot | Status |',
              '|-----|--------|',
              '| Greptile | Reviewed |',
              '| Macroscope | Reviewed |',
              '',
              '**Estimated issues**: ~' + issueCount + ' items',
              '',
              '---',
              '',
              '**Next step**: Run `/pr-update` in OpenCode to:',
              '1. Read and categorize all feedback',
              '2. Fix certain issues automatically',
              '3. Note uncertain items for your decision',
              '4. Update Macroscope.md if bots need tuning'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: summary
            });

  agent-trigger:
    name: Agent Trigger (Future)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '@agent')
    
    steps:
      - name: Parse Agent Command
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          COMMAND=$(echo "$COMMENT" | grep -oP '@agent\s+\K.*' | head -1 || echo "help")
          echo "command=$COMMAND" >> $GITHUB_OUTPUT

      - name: Acknowledge Command
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'Agent command detected. Run `/pr-update` in OpenCode to process.'
            });
